<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>快递单号上传与查询 - 多设备同步</title>
  <style>
    /* CSS 样式部分保持不变，用于美化界面 */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      color: #1a237e;
      line-height: 1.6;
    }

    .container {
      max-width: 700px;
      margin: 30px auto;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      padding: 30px;
      transition: transform 0.3s ease;
    }

    .container:hover {
      transform: translateY(-5px);
    }

    h2 {
      font-size: 1.8em;
      margin-bottom: 20px;
      color: #3f51b5;
      text-align: center;
      font-weight: 600;
      letter-spacing: 1px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #3f51b5;
      font-size: 1.1em;
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 2px solid #e8eaf6;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      background: #f8fafc;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #3f51b5;
      box-shadow: 0 0 8px rgba(63, 81, 181, 0.3);
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(90deg, #3f51b5, #5c6bc0);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease, opacity 0.2s ease;
    }

    button:hover {
      background: linear-gradient(90deg, #5c6bc0, #3f51b5);
      transform: scale(1.02);
    }

    button:active {
      transform: scale(0.98);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    hr {
      border: none;
      border-top: 1px solid #e8eaf6;
      margin: 30px 0;
    }

    .record {
      background: #f8fafc;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .record:hover {
      transform: translateX(5px);
    }

    .record strong {
      color: #3f51b5;
      font-weight: 600;
    }

    #searchResults p {
      text-align: center;
      color: #d32f2f;
      font-weight: 500;
    }

    @media (max-width: 600px) {
      .container {
        padding: 20px;
        margin: 20px;
      }

      h2 {
        font-size: 1.5em;
      }

      button {
        font-size: 1em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>快递单号上传 (Firebase 同步)</h2>
    <div>
      <label for="uploader">上传人姓名：</label>
      <input type="text" id="uploader" placeholder="请输入您的姓名" required />
    </div>
    <div>
      <label for="trackingNumbers">快递单号（每行一个）：</label>
      <textarea id="trackingNumbers" placeholder="例如：1234567890"></textarea>
    </div>
    <button id="uploadBtn">上传快递单号</button>

    <hr>

    <h2>快递单号查询</h2>
    <div>
      <label for="searchKey">输入至少 4 位数字（结尾匹配）：</label>
      <input type="text" id="searchKey" placeholder="例如：7890" />
    </div>
    <button id="searchBtn">搜索</button>
    <div id="searchResults"></div>
  </div>

  <script type="module">
    // ======================================================================
    // 1. 导入 Firebase SDK 所需的模块
    // 使用 type="module" 是 GitHub Pages 的标准做法
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9/firebase-app.js";
    import { getDatabase, ref, push, get } from "https://www.gstatic.com/firebasejs/9/firebase-database.js";
    
    // 2. 你的 Firebase 项目配置信息
    // 请确保这些信息是正确的！
    const firebaseConfig = {
      apiKey: "AIzaSyBsMYYyjo6ZIW-WomQoQobdnZ7icZreyyM",
      authDomain: "lashio-bbq.firebaseapp.com",
      projectId: "lashio-bbq",
      storageBucket: "lashio-bbq.firebasestorage.app",
      messagingSenderId: "253658588705",
      appId: "1:253658588705:web:e4df39e7764b27f7d52560",
      measurementId: "G-D1JLX43XHP"
    };
    
    // 3. 初始化 Firebase 和 Realtime Database
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const recordsRef = ref(db, 'trackingRecords'); // 数据库中的根路径
    // ======================================================================

    /**
     * 辅助函数：从 Firebase 获取所有记录并进行结尾匹配
     * 因为 Firebase Realtime DB 不支持直接的 SQL LIKE '%suffix' 结尾匹配查询。
     * 我们需要获取所有数据后，在客户端（浏览器）进行过滤。
     * @param {string} key 搜索关键词 (至少4位)
     * @returns {Promise<Array>} 匹配到的记录数组
     */
    async function searchRecordsBySuffix(key) {
        const results = [];
        const snapshot = await get(recordsRef);

        if (snapshot.exists()) {
            // snapshot.val() 返回一个包含所有记录的对象 {key1: record1, key2: record2, ...}
            const allRecords = snapshot.val();
            
            for (const keyId in allRecords) {
                // 确保只处理对象自身的属性
                if (Object.prototype.hasOwnProperty.call(allRecords, keyId)) {
                    const record = allRecords[keyId];
                    // 客户端实现“结尾匹配”
                    if (record.number && record.number.endsWith(key)) {
                        results.push(record);
                    }
                }
            }
        }
        // 按照上传时间倒序排列 (新的记录在前)
        results.sort((a, b) => new Date(b.uploadTime) - new Date(a.uploadTime)); 
        
        return results;
    }
    
    // --- 上传功能实现 ---
    document.getElementById('uploadBtn').addEventListener('click', async function(){
      const uploader = document.getElementById('uploader').value.trim();
      const text = document.getElementById('trackingNumbers').value.trim();
      const uploadBtn = document.getElementById('uploadBtn');

      if (!uploader || !text) {
        alert("请填写上传人姓名和快递单号！");
        return;
      }
      
      // 预处理单号：按行分割，去除前后空格，过滤空行
      let numbers = text.split('\n').map(s => s.trim()).filter(s => s);
      // 去除同一批内的重复
      numbers = [...new Set(numbers)];
      
      if (numbers.length === 0) {
          alert("请输入有效的快递单号！");
          return;
      }

      uploadBtn.disabled = true;
      uploadBtn.textContent = '正在上传...';

      let newCount = 0;
      const duplicates = [];
      const now = new Date().toLocaleString();

      try {
          // 1. 一次性读取现有所有数据，用于去重检查
          const snapshot = await get(recordsRef);
          // 将所有记录对象的值 (即快递单号记录) 转换为数组
          const existingRecords = snapshot.exists() ? Object.values(snapshot.val()) : [];
          // 提取所有已存在的快递单号
          const existingNumbers = existingRecords.map(rec => rec.number);

          // 2. 遍历并上传新记录
          for (const number of numbers) {
              // 检查数据库中是否已存在这个单号
              if (existingNumbers.includes(number)) {
                  duplicates.push(number);
                  continue;
              }

              // 构造新记录对象
              const newRecord = {
                number: number,
                uploader: uploader,
                uploadTime: now
              };

              // 使用 push() 方法上传数据，Firebase 会自动生成唯一的 key
              await push(recordsRef, newRecord);
              newCount++;
          }

          // 3. 反馈结果
          let message = '';
          if (newCount > 0) {
            message += `上传成功！新上传 ${newCount} 条记录。`;
          }
          if (duplicates.length > 0) {
            if (newCount > 0) message += '\n';
            message += `以下单号已存在，未重复上传：${duplicates.join(', ')}`;
          }
          
          if (newCount === 0 && duplicates.length > 0) {
              alert(`所有上传的单号已存在，无新记录上传：${duplicates.join(', ')}`);
          } else if (newCount > 0) {
              alert(message);
          }
          
          // 清空输入框
          document.getElementById('trackingNumbers').value = '';
          document.getElementById('uploader').value = '';

      } catch (error) {
        console.error('上传失败:', error);
        alert('数据上传到 Firebase 时失败。请检查网络和 Firebase 规则。');
      } finally {
        // 恢复按钮状态
        uploadBtn.disabled = false;
        uploadBtn.textContent = '上传快递单号';
      }
    });

    // --- 搜索功能实现 ---
    document.getElementById('searchBtn').addEventListener('click', async function(){
      const key = document.getElementById('searchKey').value.trim();
      const resultsDiv = document.getElementById('searchResults');
      const searchBtn = document.getElementById('searchBtn');
      
      resultsDiv.innerHTML = "";
      
      if (key.length < 4) {
        alert("请输入至少 4 位数字！");
        return;
      }
      
      searchBtn.disabled = true;
      searchBtn.textContent = '正在搜索...';

      try {
        // 调用搜索函数
        const matched = await searchRecordsBySuffix(key);
        
        if (matched.length === 0) {
          resultsDiv.innerHTML = "<p>没有找到匹配记录。</p>";
        } else {
          // 渲染结果
          matched.forEach(rec => {
            const div = document.createElement('div');
            div.className = 'record';
            div.innerHTML = `<strong>单号：</strong>${rec.number}<br>
                             <strong>上传人：</strong>${rec.uploader}<br>
                             <strong>上传时间：</strong>${rec.uploadTime}`;
            resultsDiv.appendChild(div);
          });
        }

      } catch (error) {
        console.error('查询失败:', error);
        resultsDiv.innerHTML = "<p>数据查询失败。请检查网络或 Firebase 配置。</p>";
      } finally {
        // 恢复按钮状态
        searchBtn.disabled = false;
        searchBtn.textContent = '搜索';
      }
    });
  </script>
</body>
</html>
