<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§é‡‡è´­ç®¡ç† (Ks) - äº‘åŒæ­¥ç‰ˆ</title>
    <style>
        /* 1. å…¨å±€å’Œå­—ä½“è®¾ç½® (Clear and Minimal) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            background-color: #f7f7f7; /* æµ…ç°è‰²èƒŒæ™¯ */
            color: #1c1c1e; /* æ·±è‰²æ–‡å­— */
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            background: #ffffff;
            padding: 30px;
            border-radius: 16px; /* æŸ”å’Œçš„åœ†è§’ */
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); /* æè½»å¾®çš„é˜´å½± */
            transition: box-shadow 0.3s;
        }
        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #3a3a3c;
            text-align: center;
            margin-bottom: 25px;
        }
        
        /* 2. Tab åˆ‡æ¢æ ·å¼ (Segmented Control Style) */
        .tabs {
            display: flex;
            background-color: #f0f0f0; 
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 30px;
        }
        .tab-button {
            flex-grow: 1;
            padding: 10px 15px;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: 600;
            color: #8e8e93; 
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
        }
        .tab-button.active {
            background-color: #ffffff; 
            color: #1c1c1e; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
        }
        .tab-content {
            display: none;
            padding: 10px 0;
        }
        .tab-content.active {
            display: block;
        }

        /* 3. ä¸‹å•é¡µé¢ (é€‰å“) æ ·å¼ */
        #product-list h2 {
            font-size: 18px;
            font-weight: 600;
            color: #5856d6; 
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e5ea;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        .product-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            position: relative; 
        }
        .product-item input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #c7c7cc;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .product-item input[type="checkbox"]:checked {
            background-color: #007aff; 
            border-color: #007aff;
        }
        .product-item input[type="checkbox"]:checked::before {
            content: 'âœ“';
            color: white;
            font-size: 14px;
            line-height: 18px;
            text-align: center;
            display: block;
        }
        .product-item label {
            display: flex;
            align-items: center;
            flex-grow: 1;
            font-size: 16px;
            color: #1c1c1e;
        }
        
        /* ç¼–è¾‘/åˆ é™¤æŒ‰é’®å®¹å™¨ */
        .product-actions {
            margin-left: 15px;
            display: flex;
            gap: 5px;
        }

        .action-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            color: #8e8e93; 
            transition: color 0.1s;
        }
        .action-button:hover {
            color: #5856d6;
        }
        .delete-button:hover {
            color: #ff3b30;
        }

        /* ç»“ç®—å’Œæ–°å¢æ§ä»¶ */
        .checkout-bar {
            text-align: center;
            margin-top: 40px;
        }
        .checkout-bar button {
            background-color: #34c759; 
            color: white;
            border: none;
            padding: 14px 40px;
            font-size: 17px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(52, 199, 89, 0.3);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .checkout-bar button:active {
            background-color: #2eaf4c;
            box-shadow: none;
        }
        
        /* *** æ ·å¼ä¿®å¤ï¼šæ–°å¢é¡¹è¾“å…¥æ¡†ç»Ÿä¸€ *** */
        .add-new-control {
            display: flex; 
            flex-wrap: nowrap; /* ç¡®ä¿ä¸æ¢è¡Œ */
            gap: 8px; 
            margin-top: 30px;
            padding: 15px;
            background-color: #f2f2f7; 
            border-radius: 12px;
            align-items: center;
        }
        .add-new-control input, .add-new-control select, .add-new-control button {
            padding: 10px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
            background-color: #ffffff; 
            min-height: 40px; /* ç»Ÿä¸€é«˜åº¦ */
        }
        .add-new-control input {
            flex-grow: 1;
            -webkit-appearance: none; 
            appearance: none;
            min-width: 100px; /* å…è®¸å‹ç¼© */
            border: 1px solid #d1d1d6;
        }
        .add-new-control select {
            width: 120px; /* ç¨å¾®ç¼©å°ä¸‹æ‹‰æ¡† */
            flex-shrink: 0;
            text-overflow: ellipsis; 
            border: 1px solid #d1d1d6;
        }
        .add-new-control button {
            width: 100px; /* ç¼©å°æŒ‰é’® */
            background-color: #007aff; 
            color: white;
            border: none;
            padding: 10px 0;
            cursor: pointer;
            flex-shrink: 0;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        /* *** ä¿®å¤ç»“æŸ *** */


        /* 4. è´­ç‰©è½¦/ç»“ç®—é¡µé¢æ ·å¼ (åŒä¸Š) */
        #cart-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }
        #cart-table th, #cart-table td {
            padding: 12px 0;
            border-bottom: 1px solid #e5e5ea;
            text-align: left;
        }
        #cart-table th {
            font-weight: 600;
            color: #8e8e93;
            background: none; 
            border-bottom: 2px solid #d1d1d6;
        }
        
        .cart-item-row.purchased td {
            color: #aeaeb2; 
            background-color: transparent;
        }
        .cart-item-row.purchased .item-name {
            text-decoration: line-through;
        }

        .price-input {
            width: 130px; 
            padding: 6px 8px;
            border: 1px solid #d1d1d6;
            border-radius: 6px;
            text-align: right;
            font-size: 15px;
            background-color: #f9f9f9; 
            -webkit-appearance: none; 
            appearance: none;
        }
        
        /* æ€»è®¡æ˜¾ç¤º (Card Style) */
        #cart-total-display {
            font-size: 20px;
            font-weight: 700;
            margin-top: 30px;
            padding: 15px 20px;
            background-color: #e5e5ea; 
            border-radius: 12px;
            color: #3a3a3c;
            text-align: right;
            border: none;
        }
        
        /* æ‹·è´æŒ‰é’®æ ·å¼ */
        .copy-button {
            width: 100%;
            background-color: #007aff; 
            color: white;
            border: none;
            padding: 14px 0;
            font-size: 17px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3);
            margin-top: 20px;
            margin-bottom: 10px;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .copy-button:active {
            background-color: #005bb5;
            box-shadow: none;
        }

        /* çº¢è‰²æŒ‰é’® (Destructive Action) */
        .reset-button {
            background-color: #ff3b30; 
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(255, 59, 48, 0.3);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .reset-button:active {
            background-color: #d82b2b;
            box-shadow: none;
        }
        
        /* åŠ è½½æç¤ºæ ·å¼ */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            color: #007aff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: 600;
            z-index: 1000;
            transition: opacity 0.3s;
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    æ­£åœ¨ä»äº‘ç«¯åŠ è½½é‡‡è´­æ¸…å•... ğŸš€
</div>

<div class="container">
    <h1>ğŸ›’ é‡‡è´­æ¸…å•</h1>

    <div class="tabs" id="tab-controls">
        <button class="tab-button active" data-tab="product-tab" onclick="openTab(event, 'product-tab')">ğŸ›ï¸ é€‰å“æ¸…å•</button>
        <button class="tab-button" data-tab="cart-tab" onclick="openTab(event, 'cart-tab')">ğŸ“‹ ç»“ç®—è´­ç‰©è½¦</button>
    </div>

    <div id="product-tab" class="tab-content active">
        <div id="product-list">
            </div>
        
        <div class="checkout-bar">
            <button onclick="addSelectedToCart()">âœ… åŠ å…¥è´­ç‰©è½¦å¹¶å‰å¾€ç»“ç®—</button>
        </div>
        
        <div class="add-new-control">
            <input type="text" id="new-product-input" placeholder="æ·»åŠ æ–°çš„é‡‡è´­é¡¹åˆ°æ¸…å•"> 
            <select id="new-product-category">
                </select>
            <button class="add-to-list-button" onclick="addNewProductToList()">æ·»åŠ åˆ°æ¸…å•</button>
        </div>
    </div>

    <div id="cart-tab" class="tab-content">
        <table id="cart-table">
            <thead>
                <tr>
                    <th style="width: 5%;">âœ“</th>
                    <th style="width: 65%;">é‡‡è´­å“é¡¹</th>
                    <th style="width: 30%; text-align: right;">ä»·æ ¼</th>
                </tr>
            </thead>
            <tbody id="cart-table-body">
                </tbody>
        </table>

        <div id="cart-total-display">
            æ€»æ”¯å‡º: Ks 0
        </div>
        
        <button class="copy-button" onclick="copyCartSummary()">ğŸ“‹ æ‹·è´é‡‡è´­æ¸…å•ä¸æ€»æ”¯å‡º</button>

        <button class="reset-button" onclick="resetCart()">æ¸…ç©ºå·²å®Œæˆé¡¹ç›®</button>
    </div>
</div>

<script>
    // *********************************************************************************
    // *** æ ¸å¿ƒé…ç½®ä¿¡æ¯ - ã€å·²æ›¿æ¢ä¸ºæ‚¨æ–°è´¦æˆ·çš„å®é™…ä¿¡æ¯ï¼ã€‘ ***
    // *********************************************************************************
    const JSONBIN_ID = '69158efd43b1c97be9aaa457'; // âœ… æ‚¨çš„æ–° Bin ID
    const JSONBIN_MASTER_KEY = '$2a$10$sDEJmJM09AqeDdTs7fLnCuerS4mWPFepEeFhDn9gNaT86Lwf2cUXu'; // âœ… æ‚¨çš„æ–° Master Key
    const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;
    
    // --- æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜ DOM å¼•ç”¨ ---
    const DOM = {
        productList: document.getElementById('product-list'),
        newProductCategory: document.getElementById('new-product-category'),
        newProductInput: document.getElementById('new-product-input'),
        cartTableBody: document.getElementById('cart-table-body'),
        cartTotalDisplay: document.getElementById('cart-total-display'),
        loadingOverlay: document.getElementById('loading-overlay'),
    };

    // --- è´§å¸ç¬¦å·å¸¸é‡ ---
    const CURRENCY_SYMBOL = 'Ks'; 
    const CURRENCY_SUFFIX = ` ${CURRENCY_SYMBOL}`; 
    
    const formatter = new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 0, 
        maximumFractionDigits: 0
    });
    
    // æ ¸å¿ƒæ•°æ®ç»“æ„
    let cloudData = {
        productTemplate: {}, // ä¸»æ¸…å•
        cartData: []         // è´­ç‰©è½¦æ•°æ®
    };
    
    let grandTotalCost = 0; 

    // --- æ™ºèƒ½åˆ†ç±»å…³é”®å­—æ˜ å°„ (ä¿æŒä¸å˜) ---
    const KEYWORD_MAP = {
        'é¸¡': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©', 'ç‰›': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©', 'çŒª': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©',
        'ç¾Š': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©', 'é±¼': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©', 'è™¾': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©',
        'æµ·é²œ': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©', 'è‚‰': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©',
        'èœ': 'è”¬èœ ğŸ¥¬', 'è‡': 'è”¬èœ ğŸ¥¬', 'æœ': 'è”¬èœ ğŸ¥¬', 'è±†': 'è”¬èœ ğŸ¥¬', 'æ¤’': 'è”¬èœ ğŸ¥¬',
        'æ–™': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„', 'é…±': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„', 'é†‹': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„',
        'æ²¹': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„', 'è‘±': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„', 'è’œ': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„',
        'ç›': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„', 'å§œ': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„',
    };

    // --- å®ç”¨å·¥å…·å‡½æ•° (ä¿æŒä¸å˜) ---
    function parseFormattedPrice(formattedString) {
        if (!formattedString) return '';
        // ç§»é™¤æ‰€æœ‰éæ•°å­—å­—ç¬¦ï¼Œä½†ä¿ç•™è‹±æ–‡å¥å·ï¼ˆå¦‚æœéœ€è¦å°æ•°ï¼‰
        const cleanedString = String(formattedString).replace(/[^0-9.]/g, ''); 
        return parseFloat(cleanedString) || '';
    }

    function formatPrice(number) {
        const num = parseFloat(number);
        if (isNaN(num) || num === 0) return '';
        return formatter.format(num) + CURRENCY_SUFFIX;
    }
    
    function getCategoryByKeyword(itemName) {
        for (const keyword in KEYWORD_MAP) {
            if (itemName.includes(keyword)) {
                return KEYWORD_MAP[keyword];
            }
        }
        return null; 
    }

    function sortCategory(categoryKey) {
        if (cloudData.productTemplate[categoryKey]) {
            cloudData.productTemplate[categoryKey].sort((a, b) => a.localeCompare(b, 'zh-CN'));
        }
    }
    
    function populateCategorySelect() {
        let optionsHtml = '';
        // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªé»˜è®¤åˆ†ç±»ï¼Œä»¥é˜²æ¨¡æ¿ä¸ºç©º
        if (Object.keys(cloudData.productTemplate).length === 0) {
             optionsHtml += `<option value="é»˜è®¤åˆ†ç±»">é»˜è®¤åˆ†ç±»</option>`;
             cloudData.productTemplate["é»˜è®¤åˆ†ç±»"] = [];
        } else {
             for (const category in cloudData.productTemplate) {
                 optionsHtml += `<option value="${category}">${category}</option>`;
             }
        }
        
        DOM.newProductCategory.innerHTML = optionsHtml;
        if (DOM.newProductCategory.options.length > 0) {
            DOM.newProductCategory.selectedIndex = 0;
        }
    }

    // --- äº‘åŒæ­¥å‡½æ•° ---
    
    async function loadProductsFromCloud() {
        if (!JSONBIN_ID || !JSONBIN_MASTER_KEY) {
             cloudData = { productTemplate: {"é»˜è®¤åˆ†ç±»": ["ç¤ºä¾‹å•†å“"]}, cartData: [] };
             DOM.loadingOverlay.textContent = "â— é”™è¯¯ï¼šè¯·æ£€æŸ¥ä»£ç ä¸­çš„ Master Key æˆ– Bin IDã€‚";
             
             for (const category in cloudData.productTemplate) {
                sortCategory(category);
            }
            renderProductList();
            populateCategorySelect(); 
            renderCart(); 
            
            const savedTab = sessionStorage.getItem('activeTab') || 'product-tab';
            openTab(null, savedTab);

            DOM.loadingOverlay.style.opacity = '0';
            setTimeout(() => DOM.loadingOverlay.style.display = 'none', 300);
            return;
        }

        try {
            const response = await fetch(JSONBIN_URL, {
                method: 'GET',
                headers: {
                    'X-Master-Key': JSONBIN_MASTER_KEY 
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}. è¯·æ£€æŸ¥ Bin ID å’Œ Master Keyã€‚`);
            }

            const json = await response.json();
            
            if (json && json.record && json.record.productTemplate && Array.isArray(json.record.cartData)) {
                cloudData.productTemplate = json.record.productTemplate;
                cloudData.cartData = json.record.cartData;
            } else if (json && json.record && typeof json.record === 'object') {
                // å¦‚æœ Bin é¦–æ¬¡åˆ›å»ºä¸ºç©ºï¼Œæˆ–åªåŒ…å«åˆå§‹ JSONï¼Œæˆ‘ä»¬ç¡®ä¿ç»“æ„æ­£ç¡®
                if (!json.record.productTemplate) {
                     cloudData.productTemplate = {"é»˜è®¤åˆ†ç±»": []};
                } else {
                    cloudData.productTemplate = json.record.productTemplate;
                }
                if (!json.record.cartData) {
                    cloudData.cartData = [];
                } else {
                    cloudData.cartData = json.record.cartData;
                }
            } else {
                // å¦‚æœäº‘ç«¯æ•°æ®ä¸ºç©ºï¼Œåˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤ç»“æ„
                cloudData.productTemplate = {"é»˜è®¤åˆ†ç±»": []};
                cloudData.cartData = [];
            }
        } catch (error) {
            console.error('åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥:', error);
            DOM.loadingOverlay.textContent = `âŒ åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®æˆ– Bin æƒé™ã€‚è¯¦æƒ…: ${error.message}`;
            alert("åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥ï¼è¯·æ£€æŸ¥ JSONBin é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œç‰¹åˆ«æ˜¯ Bin ID å’Œ Master Keyã€‚");
        } finally {
            for (const category in cloudData.productTemplate) {
                sortCategory(category);
            }
            renderProductList();
            populateCategorySelect(); 
            renderCart(); 
            
            const savedTab = sessionStorage.getItem('activeTab') || 'product-tab';
            openTab(null, savedTab);

            DOM.loadingOverlay.style.opacity = '0';
            setTimeout(() => DOM.loadingOverlay.style.display = 'none', 300);
        }
    }

    async function saveProductsToCloud() {
        if (!JSONBIN_ID || !JSONBIN_MASTER_KEY) {
            alert("â— è­¦å‘Šï¼šMaster Key æˆ– Bin ID ç¼ºå¤±ï¼Œæ•°æ®æ— æ³•ä¸Šä¼ ï¼");
            return;
        }
        
        const dataToSave = cloudData; 

        try {
            const response = await fetch(JSONBIN_URL, {
                method: 'PUT', 
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': JSONBIN_MASTER_KEY, 
                    'X-Bin-Versioning': 'false' 
                },
                body: JSON.stringify(dataToSave)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
        } catch (error) {
            console.error('ä¿å­˜äº‘ç«¯æ•°æ®å¤±è´¥:', error);
            alert("è­¦å‘Šï¼šæ•°æ®ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– Master Key æ˜¯å¦æœ‰å†™å…¥æƒé™ã€‚");
        }
    }
    
    // --- åˆå§‹åŒ–å’ŒåŠ è½½ ---

    document.addEventListener('DOMContentLoaded', () => {
        loadProductsFromCloud(); 
    });

    function openTab(evt, tabName) {
        sessionStorage.setItem('activeTab', tabName);
        
        let tabcontent = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
            tabcontent[i].style.display = "none";
        }
        
        let tablinks = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
        
        document.getElementById(tabName).classList.add("active");
        document.getElementById(tabName).style.display = "block";
        if (evt) {
            evt.currentTarget.classList.add("active");
        } else {
            const initialTabButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
            if (initialTabButton) initialTabButton.classList.add("active");
        }
        
        if (tabName === 'cart-tab') {
            renderCart(); 
        }
    }
    
    // --- 1. ä¸‹å•é¡µé¢é€»è¾‘ (é€‰å“) ---

    function renderProductList() {
        let listHtml = '';
        
        const cartItemNames = new Set(cloudData.cartData.map(item => item.name));
        
        for (const category in cloudData.productTemplate) {
            sortCategory(category); 
            
            listHtml += `<h2>${category}</h2>`;

            const items = cloudData.productTemplate[category];
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const uniqueId = `${category}-${item}`;
                
                const escapedCategory = category.replace(/'/g, "\\'");
                const escapedItem = item.replace(/'/g, "\\'");

                // å¦‚æœé¡¹ç›®åœ¨è´­ç‰©è½¦ä¸­ï¼Œåˆ™è‡ªåŠ¨å‹¾é€‰
                const isChecked = cartItemNames.has(item) ? 'checked' : '';

                listHtml += `
                    <div class="product-item">
                        <input type="checkbox" id="item-${uniqueId}" data-item-name="${item}" ${isChecked}>
                        <label for="item-${uniqueId}" style="flex-grow:1; cursor:pointer;">${item}</label>
                        <div class="product-actions">
                            <button class="action-button edit-button" 
                                    onclick="editProduct('${escapedCategory}', '${escapedItem}')">
                                âœï¸
                            </button>
                            <button class="action-button delete-button" 
                                    onclick="deleteProduct('${escapedCategory}', '${escapedItem}')">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        DOM.productList.innerHTML = listHtml;
    }
    
    async function editProduct(category, oldName) {
        const newName = prompt(`è¯·è¾“å…¥ "${oldName}" çš„æ–°åç§°ï¼š`, oldName);
        
        if (newName && newName.trim() !== oldName) {
            const trimmedNewName = newName.trim();
            
            let isDuplicate = false;
            for (const cat in cloudData.productTemplate) {
                if (cloudData.productTemplate[cat].includes(trimmedNewName)) {
                    isDuplicate = true;
                    break;
                }
            }

            if (isDuplicate) {
                alert(`"${trimmedNewName}" å·²ç»åœ¨æ¸…å•ä¸­ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°ï¼`);
                return;
            }
            
            const list = cloudData.productTemplate[category];
            const oldIndex = list.indexOf(oldName);
            
            if (oldIndex !== -1) {
                list[oldIndex] = trimmedNewName;
                sortCategory(category);
                
                for (let i = 0; i < cloudData.cartData.length; i++) {
                    if (cloudData.cartData[i].name === oldName) {
                        cloudData.cartData[i].name = trimmedNewName;
                        break; 
                    }
                }
                
                await saveProductsToCloud();
                
                renderProductList();
                renderCart();
            }
        }
    }
    
    async function deleteProduct(category, name) {
        if (confirm(`ç¡®å®šè¦ä»æ¸…å•ä¸­åˆ é™¤é‡‡è´­é¡¹ "${name}" å—ï¼Ÿæ­¤æ“ä½œå°†æ— æ³•æ’¤é”€ã€‚`)) {
            const list = cloudData.productTemplate[category];
            const oldIndex = list.indexOf(name);
            
            if (oldIndex !== -1) {
                list.splice(oldIndex, 1);
                
                cloudData.cartData = cloudData.cartData.filter(item => item.name !== name);
                
                await saveProductsToCloud();
                
                renderProductList();
                renderCart();
            }
        }
    }

    async function addSelectedToCart() {
        const checkboxes = document.querySelectorAll('#product-list input[type="checkbox"]');
        let selectedCount = 0;
        
        const existingCartMap = new Map();
        for (const item of cloudData.cartData) {
            existingCartMap.set(item.name, { purchased: item.purchased, price: item.price });
        }
        
        const newCartItems = [];
        const selectedItemNames = new Set();
        
        for (const checkbox of checkboxes) {
            const itemName = checkbox.getAttribute('data-item-name');
            const existingItem = existingCartMap.get(itemName);

            if (checkbox.checked) {
                newCartItems.push({
                    name: itemName,
                    purchased: existingItem ? existingItem.purchased : false,
                    price: existingItem ? existingItem.price : ''
                });
                selectedItemNames.add(itemName);
                selectedCount++;
                
                // æ ¸å¿ƒï¼šç«‹å³å–æ¶ˆ DOM ä¸Šçš„å‹¾é€‰çŠ¶æ€
                checkbox.checked = false;
            }
        }
        
        // ç¡®ä¿æœªåœ¨å½“å‰æ“ä½œä¸­è¢«é€‰ä¸­çš„æ—§è´­ç‰©è½¦é¡¹ç›®ä¹Ÿä¿ç•™
        for (const item of cloudData.cartData) {
            if (!selectedItemNames.has(item.name)) {
                 newCartItems.push(item);
            }
        }

        cloudData.cartData = newCartItems; 
        
        if (selectedCount === 0) {
            alert("è¯·å…ˆå‹¾é€‰æ‚¨è¦é‡‡è´­çš„å•†å“ï¼");
            return;
        }
        
        await saveProductsToCloud(); 
        
        renderCart();
        
        openTab(null, 'cart-tab');
        alert(`æˆåŠŸæ·»åŠ  ${selectedCount} ä»¶å•†å“åˆ°è´­ç‰©è½¦ï¼Œè¯·åœ¨ç»“ç®—é¡µè®°å½•ä»·æ ¼ï¼`);
    }

    async function addNewProductToList() {
        const itemName = DOM.newProductInput.value.trim();
        const selectedCategoryKey = DOM.newProductCategory.value;

        if (itemName === "") {
            alert("è¯·è¾“å…¥é‡‡è´­é¡¹åç§°ã€‚");
            return;
        }
        
        for (const category in cloudData.productTemplate) {
            if (cloudData.productTemplate[category].includes(itemName)) {
                 alert(`"${itemName}" å·²ç»åœ¨æ¸…å•ä¸­ï¼`);
                 DOM.newProductInput.value = ''; 
                 DOM.newProductInput.focus();
                 return;
            }
        }

        const smartCategoryKey = getCategoryByKeyword(itemName);
        const targetCategoryKey = smartCategoryKey || selectedCategoryKey;
        
        // å¦‚æœç›®æ ‡åˆ†ç±»ä¸å­˜åœ¨
        if (!cloudData.productTemplate[targetCategoryKey]) {
            cloudData.productTemplate[targetCategoryKey] = [];
        }
        
        cloudData.productTemplate[targetCategoryKey].push(itemName);
         
        sortCategory(targetCategoryKey); 
         
        await saveProductsToCloud();
         
        renderProductList(); 
         
        // è‡ªåŠ¨å‹¾é€‰æ–°æ·»åŠ çš„é¡¹
        const newCheckbox = document.querySelector(`input[data-item-name="${itemName}"]`);
        if (newCheckbox) {
            newCheckbox.checked = true;
        }
        
        populateCategorySelect(); // æ›´æ–°åˆ†ç±»ä¸‹æ‹‰æ¡†
        
        alert("æ–°é¡¹ç›®å·²æ·»åŠ åˆ°æ¸…å•å¹¶å‹¾é€‰ï¼Œè¯·ç‚¹å‡» 'åŠ å…¥è´­ç‰©è½¦å¹¶å‰å¾€ç»“ç®—' å®Œæˆæ·»åŠ ã€‚");
             
        DOM.newProductInput.value = ''; 
        DOM.newProductInput.focus();
    }


    // --- 2. è´­ç‰©è½¦é€»è¾‘ (ç»“ç®—å’Œä»·æ ¼è®°å½•) ---
    
    function renderCart() {
        let tableHtml = '';
        
        const cartItems = cloudData.cartData; 

        if (cartItems.length === 0) {
            tableHtml = `<tr><td colspan="3" style="text-align: center; padding: 20px; color:#8e8e93;">è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œè¯·åœ¨é€‰å“æ¸…å•ä¸­å‹¾é€‰ï¼</td></tr>`;
        } else {
            for (let index = 0; index < cartItems.length; index++) {
                const item = cartItems[index];
                const purchasedClass = item.purchased ? 'purchased' : '';
                const checkedAttr = item.purchased ? 'checked' : '';
                
                // æ¸²æŸ“æ—¶ï¼Œæ˜¾ç¤ºæ ¼å¼åŒ–åçš„ä»·æ ¼
                const displayValue = formatPrice(item.price);
                
                tableHtml += `
                    <tr class="cart-item-row ${purchasedClass}">
                        <td>
                            <input type="checkbox" ${checkedAttr} onchange="togglePurchased(${index})">
                        </td>
                        <td><span class="item-name">${item.name}</span></td>
                        <td style="text-align: right;">
                            <input type="number" 
                                class="price-input" 
                                value="${item.price || ''}" 
                                placeholder="0" 
                                inputmode="numeric" 
                                pattern="[0-9]*"
                                onchange="updateItemPrice(${index}, this.value, this)">
                        </td>
                    </tr>
                `;
            }
        }
        DOM.cartTableBody.innerHTML = tableHtml;
        calculateTotalCost();
    }
    
    // *** æ ¸å¿ƒä¿®å¤ V8ï¼šé‡‡ç”¨ onchange äº‹ä»¶å¤„ç†ä»·æ ¼æ›´æ–° ***
    async function updateItemPrice(index, rawValueString, inputElement) {
        // 1. è§£æè¾“å…¥å€¼
        const rawValue = parseFormattedPrice(rawValueString);
        const cartItems = cloudData.cartData;

        // 2. ç¡®å®šçŠ¶æ€
        const isPurchased = (rawValue !== '' && rawValue > 0);
        
        // 3. æ›´æ–°åº•å±‚æ•°æ®
        cartItems[index].price = rawValue; 
        cartItems[index].purchased = isPurchased;
        
        // 4. æ›´æ–°è¡Œæ ·å¼å’Œå¤é€‰æ¡†çŠ¶æ€
        const row = inputElement.closest('.cart-item-row');
        if (row) {
            row.classList.toggle('purchased', isPurchased);
            row.querySelector('input[type="checkbox"]').checked = isPurchased;
        }

        calculateTotalCost(); 
        await saveProductsToCloud();
    }

    async function togglePurchased(index) {
        const cartItems = cloudData.cartData;
        const currentCheckbox = event.target; 
        const isChecked = currentCheckbox.checked;
        const row = currentCheckbox.closest('.cart-item-row');
        const priceInput = row.querySelector('.price-input');
        
        cartItems[index].purchased = isChecked;

        if (!isChecked) {
            // å¦‚æœå–æ¶ˆå‹¾é€‰ï¼Œæ¸…é™¤ä»·æ ¼å’Œè¾“å…¥æ¡†æ˜¾ç¤º
            cartItems[index].price = '';
            priceInput.value = ''; // æ¸…é™¤çº¯æ•°å­—è¾“å…¥æ¡†
        }
        
        calculateTotalCost(); 
        
        row.classList.toggle('purchased', isChecked);
        
        await saveProductsToCloud(); 
    }

    function calculateTotalCost() {
        let total = 0;
        const cartItems = cloudData.cartData;
        
        for (let i = 0; i < cartItems.length; i++) {
            const item = cartItems[i];
            const price = parseFloat(item.price);
            if (item.purchased && !isNaN(price) && price > 0) {
                 total += price;
            }
        }
        
        grandTotalCost = total; 
        DOM.cartTotalDisplay.textContent = `æ€»æ”¯å‡º: ${formatter.format(grandTotalCost)}${CURRENCY_SUFFIX}`;
    }
    
    async function copyCartSummary() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const todayDate = `${year}-${month}-${day}`;

        let summaryText = `ğŸ“… ${todayDate} é‡‡è´­æ€»ç»“:\n\n`; 
        let hasPurchasedItems = false;
        const cartItems = cloudData.cartData;
        
        for (let i = 0; i < cartItems.length; i++) {
            const item = cartItems[i];
            const price = parseFormattedPrice(item.price);
            if (item.purchased && price !== '' && price > 0) {
                hasPurchasedItems = true;
                const formattedPrice = formatPrice(price);
                summaryText += `${item.name}: ${formattedPrice}\n`;
            }
        }
        
        if (!hasPurchasedItems) {
            alert("è¯·å…ˆåœ¨æ¸…å•ä¸­å‹¾é€‰å·²é‡‡è´­é¡¹ç›®å¹¶å¡«å†™ä»·æ ¼ï¼");
            return;
        }

        summaryText += "\n------------------\n";
        summaryText += `ğŸ’° æ€»æ”¯å‡º: ${formatter.format(grandTotalCost)}${CURRENCY_SUFFIX}`;
        
        try {
            if (navigator.clipboard) {
                await navigator.clipboard.writeText(summaryText);
                alert("ğŸ›’ é‡‡è´­æ¸…å• (å«æ—¥æœŸ) å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = summaryText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert("ğŸ›’ é‡‡è´­æ¸…å• (å«æ—¥æœŸ) å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
            }
        } catch (err) {
            console.error('æ— æ³•å¤åˆ¶å†…å®¹:', err);
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹å†…å®¹:\n\n' + summaryText);
        }
    }

    async function resetCart() {
        const cartItems = cloudData.cartData;
        const purchasedItems = cartItems.filter(item => item.purchased);

        if (purchasedItems.length === 0) {
            alert("æ²¡æœ‰å·²å®Œæˆ (å·²å‹¾é€‰ä¸”å·²å¡«å†™ä»·æ ¼) çš„é¡¹ç›®å¯ä»¥æ¸…ç©ºã€‚");
            return;
        }

        if (confirm(`ç¡®å®šè¦æ¸…ç©º ${purchasedItems.length} ä¸ªå·²å®Œæˆçš„é¡¹ç›®å—ï¼Ÿ`)) {
            cloudData.cartData = cartItems.filter(item => !item.purchased);
            
            await saveProductsToCloud(); 
            
            renderCart();
            
            openTab(null, 'product-tab');
            renderProductList(); 

            alert(`å·²æˆåŠŸæ¸…ç©º ${purchasedItems.length} ä¸ªå·²å®Œæˆçš„é¡¹ç›®ï¼`);
        }
    }
</script>
</body>
</html>
