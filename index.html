<script type="module">
    // ======================================================================
    // 1. 导入 Firebase SDK (确保导入 database 模块)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, push, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    
    // 2. 你的【新】Firebase 项目配置信息 (hujunda-8d205)
    // 注意：这里的配置必须完整匹配你在 Firebase 注册时得到的配置。
    const firebaseConfig = {
      apiKey: "AIzaSyCBW4wP4ROOIcUp-p2EdKvu2c0_w5m0LW8", // 你的API Key
      authDomain: "hujunda-8d205.firebaseapp.com",
      projectId: "hujunda-8d205",
      storageBucket: "hujunda-8d205.firebasestorage.app",
      messagingSenderId: "956966084475",
      appId: "1:956966084475:web:16dc41636c2aa2483667de",
      measurementId: "G-6NFT87MWVV",
      // 关键：Realtime Database URL，使用你的新项目 ID
      databaseURL: "https://hujunda-8d205-default-rtdb.firebaseio.com" 
    };
    
    // 3. 初始化 Firebase 和 Realtime Database
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const recordsRef = ref(db, 'trackingRecords'); // 数据库中的根路径
    // ======================================================================

    /**
     * 辅助函数：从 Firebase 获取所有记录并进行结尾匹配
     */
    async function searchRecordsBySuffix(key) {
        // ... (保持不变)
        const results = [];
        const snapshot = await get(recordsRef);

        if (snapshot.exists()) {
            const allRecords = snapshot.val();
            
            for (const keyId in allRecords) {
                if (Object.prototype.hasOwnProperty.call(allRecords, keyId)) {
                    const record = allRecords[keyId];
                    if (record.number && record.number.endsWith(key)) {
                        results.push(record);
                    }
                }
            }
        }
        results.sort((a, b) => new Date(b.uploadTime) - new Date(a.uploadTime)); 
        
        return results;
    }
    
    // --- 上传功能实现 ---
    document.getElementById('uploadBtn').addEventListener('click', async function(){
      const uploader = document.getElementById('uploader').value.trim();
      const text = document.getElementById('trackingNumbers').value.trim();
      const uploadBtn = document.getElementById('uploadBtn');

      if (!uploader || !text) {
        alert("请填写上传人姓名和快递单号！");
        return;
      }
      
      let numbers = text.split('\n').map(s => s.trim()).filter(s => s);
      numbers = [...new Set(numbers)];
      
      if (numbers.length === 0) {
          alert("请输入有效的快递单号！");
          return;
      }

      uploadBtn.disabled = true;
      uploadBtn.textContent = '正在上传...';

      let newCount = 0;
      const duplicates = [];
      const now = new Date().toLocaleString();

      try {
          // 1. 读取现有数据
          const snapshot = await get(recordsRef);

          const existingRecords = snapshot.exists() ? Object.values(snapshot.val()) : [];
          const existingNumbers = existingRecords.map(rec => rec.number);

          // 2. 遍历并上传新记录
          for (const number of numbers) {
              if (existingNumbers.includes(number)) {
                  duplicates.push(number);
                  continue;
              }

              const newRecord = {
                number: number,
                uploader: uploader,
                uploadTime: now
              };
              
              await push(recordsRef, newRecord);
              newCount++;
          }

          // 3. 反馈结果
          let message = '';
          if (newCount > 0) {
            message += `上传成功！新上传 ${newCount} 条记录。`;
          }
          if (duplicates.length > 0) {
            if (newCount > 0) message += '\n';
            message += `以下单号已存在，未重复上传：${duplicates.join(', ')}`;
          }
          
          if (newCount === 0 && duplicates.length > 0) {
              alert(`所有上传的单号已存在，无新记录上传：${duplicates.join(', ')}`);
          } else if (newCount > 0) {
              alert(message);
          }
          
          document.getElementById('trackingNumbers').value = '';
          document.getElementById('uploader').value = '';

      } catch (error) {
        console.error('Firebase 操作失败:', error);
        alert(`上传失败！\n\n【错误原因】：${error.message}\n\n【请立即检查】：\n1. 数据库 "Rules" (规则) 是否已设置为 .read 和 .write 均为 'true'？\n2. 浏览器缓存是否清除？`);
      
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = '上传快递单号';
      }
    });

    // --- 搜索功能实现 (保持不变) ---
    document.getElementById('searchBtn').addEventListener('click', async function(){
      const key = document.getElementById('searchKey').value.trim();
      const resultsDiv = document.getElementById('searchResults');
      const searchBtn = document.getElementById('searchBtn');
      
      resultsDiv.innerHTML = "";
      
      if (key.length < 4) {
        alert("请输入至少 4 位数字！");
        return;
      }
      
      searchBtn.disabled = true;
      searchBtn.textContent = '正在搜索...';

      try {
        const matched = await searchRecordsBySuffix(key);
        
        if (matched.length === 0) {
          resultsDiv.innerHTML = "<p>没有找到匹配记录。</p>";
        } else {
          matched.forEach(rec => {
            const div = document.createElement('div');
            div.className = 'record';
            div.innerHTML = `<strong>单号：</strong>${rec.number}<br>
                             <strong>上传人：</strong>${rec.uploader}<br>
                             <strong>上传时间：</strong>${rec.uploadTime}`;
            resultsDiv.appendChild(div);
          });
        }

      } catch (error) {
        console.error('查询失败:', error);
        alert(`查询失败！\n错误信息: ${error.message}\n\n请检查 Firebase "Rules" (规则) 是否已设置为 .read: 'true'。`);
      } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = '搜索';
      }
    });
  </script>
